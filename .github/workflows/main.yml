# .github/workflows/sync-to-notion.yml
name: Sync commits to Notion

on:
  push:

jobs:
  notion:
    runs-on: ubuntu-latest
    steps:
      # 1) Check out full history so we can read all commits' payload
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) For each commit, create a Notion page (no file list)
      - name: Send commits to Notion
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = context.payload.commits || [];
            for (const c of commits) {
              // split into title + body
              const [title, ...bodyLines] = c.message.split(/\r?\n/);
              const description = bodyLines.join(" ");

              await fetch("https://api.notion.com/v1/pages", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.NOTION_SECRET}`,
                  "Notion-Version": "2022-06-28",
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  parent: { database_id: process.env.NOTION_DATABASE },
                  properties: {
                    Title: {
                      title: [{ text: { content: title } }]
                    },
                    Url: {
                      url: c.url
                    },
                    Id: {
                      rich_text: [{ text: { content: c.id } }]
                    },
                    Project: {
                      multi_select: [{ name: context.repo.repo }]
                    }
                  },
                  children: [
                    {
                      object: "block",
                      type: "paragraph",
                      paragraph: {
                        text: [
                          { type: "text", text: { content: description } }
                        ]
                      }
                    }
                  ]
                })
              });
            }
        env:
          NOTION_SECRET:   ${{ secrets.NOTION_SECRET }}
          NOTION_DATABASE: ${{ secrets.NOTION_DATABASE }}

